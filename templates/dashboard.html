<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindle Oasis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* E-Ink Optimization */
        body {
            background-color: black; /* Border Color via Gap */
            color: black;
            font-family: 'Noto Sans SC', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            /* Oasis 2 Landscape Resolution */
            width: 1680px;
            height: 1264px;
            overflow: hidden;
            margin: 0;
            padding: 0;
            /* Flex layout for the gap grid */
            display: flex;
            flex-direction: column;
            gap: 4px; /* The "Border" thickness */
            /* border: 4px solid black; Removed Outer Border */
            box-sizing: border-box;
        }
        
        .panel {
            background-color: white;
        }
        
        .sparkline {
            filter: grayscale(100%) contrast(200%);
        }
    </style>
</head>
<body>

    <!-- Root Flex Container for 50/50 Split -->
    <!-- Gap is 4px. Body height 1264. Gap 4. 
         Available height = 1264. 
         Minus gap 4 = 1260. 
         Top/Bottom = 630px each. -->
    <div class="flex flex-col flex-1 h-full gap-[4px]">

        <!-- TOP HALF (50%) -->
        <div class="flex flex-1 gap-[4px] min-h-0">
            
            <!-- 1. Time & Calendar (Top Left) -->
            <div class="panel w-1/2 flex flex-col justify-between p-8 relative">
                <!-- Top: Date Info -->
                <div class="flex flex-row justify-between items-start">
                    <div>
                         <div class="text-4xl font-bold mb-2 tracking-wide">
                            {{ calendar.date_str }}
                        </div>
                        <!-- Weekday -->
                        <div class="{% if config.LANGUAGE == 'EN' %}text-[5.5rem]{% else %}text-[7rem]{% endif %} font-black leading-none mb-3 uppercase tracking-tight">{{ calendar.weekday }}</div>
                        <div class="text-6xl font-bold mt-1 text-gray-800">{{ calendar.lunar }}</div>
                        
                        {% if calendar.holiday %}
                        <div class="inline-block bg-black text-white text-4xl font-bold px-6 py-3 mt-4">
                            {% if config.LANGUAGE == 'EN' %}Holiday:{% else %}节假日:{% endif %} {{ calendar.holiday }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Next Non-Working Day -->
                    {% if calendar.next_non_working %}
                    <div class="text-right pt-2">
                         <div class="text-4xl font-bold text-gray-500 uppercase tracking-widest mb-2">{% if config.LANGUAGE == 'EN' %}Next Off{% else %}下个休息{% endif %}</div>
                         <div class="text-6xl font-black leading-none">{{ calendar.next_non_working.date }}</div>
                         <div class="text-4xl font-bold mt-2">{{ calendar.next_non_working.name }}</div>
                         <div class="text-3xl font-bold text-gray-400 mt-2">{% if config.LANGUAGE == 'EN' %}In {{ calendar.next_non_working.days_away }} days{% else %}{{ calendar.next_non_working.days_away }}天后{% endif %}</div>
                    </div>
                    {% endif %}
                </div>

                <!-- Divider -->
                <div class="h-[4px] bg-black w-full mt-6"></div>

                <!-- Bottom: Reserved for local time (rendered by Kindle) -->
                <div id="local-time-placeholder" class="flex-grow flex items-center justify-center">
                </div>
            </div>

            <!-- 2. Weather & Forecast (Top Right) -->
            <div class="panel w-1/2 flex flex-col p-8 pb-4 justify-between"> 
                <!-- Top Part: Current Weather -->
                <div class="flex flex-col flex-grow justify-start pt-2">
                    <!-- Header Row: City + Environmental Indicators -->
                    <div class="flex justify-between items-start mb-4">
                        <!-- Left: City Name (smaller) -->
                        <div>
                             <span class="text-4xl font-bold text-gray-700 block">{{ weather.location.name }}</span>
                        </div>
                        
                        <!-- Right: Environmental Indicators Row -->
                        <div class="flex items-start gap-6">
                            <!-- Humidity -->
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-500 mb-1">{% if config.LANGUAGE == 'EN' %}Humid{% else %}湿度{% endif %}</div>
                                <div class="text-4xl font-black">{{ weather.current.humidity }}</div>
                            </div>
                            <!-- UV Index -->
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-500 mb-1">UV</div>
                                <div class="text-4xl font-black">{{ weather.current.uv }}</div>
                            </div>
                            <!-- AQI -->
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-500 mb-1">{% if config.LANGUAGE == 'EN' %}AQI{% else %}空气{% endif %}</div>
                                <div class="text-4xl font-black">{{ weather.current.aqi }}</div>
                            </div>
                            <!-- Rain Probability -->
                            <div class="text-center">
                                <div class="text-2xl font-bold text-gray-500 mb-1">{% if config.LANGUAGE == 'EN' %}Rain{% else %}降雨{% endif %}</div>
                                <div class="text-4xl font-black">{{ weather.current.rain_chance }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Main Weather Display -->
                    <div class="flex items-start justify-between px-2 mt-4">
                        <!-- Left: Icon + Weather Name (Same Line) and Alerts Below -->
                        <div class="flex flex-col">
                            <!-- Icon and Weather Name in Same Row -->
                            <div class="flex items-center">
                                <img src="http://openweathermap.org/img/wn/{{ weather.current.icon }}@4x.png" class="w-[160px] h-[160px] grayscale invert contrast-125 drop-shadow-sm -ml-6 -my-4">
                                <span class="text-6xl font-black ml-2">{{ weather.current.desc }}</span>
                            </div>
                            
                            <!-- Future Weather Alerts (48h) -->
                            <div class="mt-6 ml-8">
                                {% if weather.current.has_warning %}
                                <!-- Government Warning: Black background -->
                                <div class="inline-block text-3xl font-black bg-black text-white px-4 py-2">
                                    ⚠ {{ weather.current.alert }}
                                </div>
                                {% elif weather.current.alert %}
                                <!-- Rain/Snow forecast -->
                                <div class="inline-block text-3xl font-bold text-gray-400 px-1 py-1">
                                    {{ weather.current.alert }}
                                </div>
                                {% else %}
                                <!-- No rain/snow: Gray text -->
                                <div class="inline-block text-3xl font-bold text-gray-400 px-1 py-1">
                                    {% if config.LANGUAGE == 'EN' %}No rain/snow recently{% else %}近期无雨雪{% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Right: Temperature and High/Low (Aligned) -->
                        <div class="text-right flex flex-col items-end justify-center tabular-nums">
                            <div class="text-[9rem] font-black leading-[0.85] tracking-tighter">{{ weather.current.temp }}°</div>
                            <div class="text-4xl font-bold text-gray-400 mt-8 mr-12 tracking-tight">{{ weather.current.high_low }}</div>
                        </div>
                    </div>
                </div>


                <!-- Bottom Part: Hourly Forecast + Tomorrow -->
                <!-- Increased height from 160px to 220px/auto to breathe, but ensured content fits -->
                <div class="grid grid-cols-4 h-[220px] pb-2 items-end">
                    <!-- 3 Hourly Slots -->
                    {% for item in weather.forecast %}
                    <div class="flex flex-col items-center justify-end h-full border-r-2 border-gray-200 relative px-2 py-1">
                        <span class="text-3xl font-bold mb-1">{{ item.label }}</span>
                        <img src="http://openweathermap.org/img/wn/{{ item.icon }}@2x.png" class="w-[70px] h-[70px] grayscale invert contrast-125 mb-0">
                        <span class="text-5xl font-black mt-0 leading-none">{{ item.temp }}°</span>
                        <span class="text-3xl font-bold text-gray-500 mt-1 truncate w-full text-center">{{ item.desc }}</span>
                    </div>
                    {% endfor %}
                    
                    <!-- Tomorrow -->
                    <div class="flex flex-col items-center justify-end h-full px-2 py-1">
                         <span class="text-3xl font-bold mb-1">{{ weather.tomorrow.label }}</span>
                         <img src="http://openweathermap.org/img/wn/{{ weather.tomorrow.icon }}@2x.png" class="w-[70px] h-[70px] grayscale invert contrast-125 mb-0">
                         <!-- High/Low -->
                         <span class="text-5xl font-black mt-0 leading-none">{{ weather.tomorrow.temp }}</span>
                         <span class="text-3xl font-bold text-gray-500 mt-1 truncate w-full text-center">{{ weather.tomorrow.desc }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- BOTTOM HALF (50%) -->
        <div class="flex flex-1 gap-[4px] min-h-0">

            <!-- Left: Hacker News (65%) -->
            <div class="panel w-[65%] flex flex-col p-8 pr-10">
                <!-- Distribute vertically -->
                <div class="flex flex-col flex-grow justify-around py-1">
                    {% for story in news[:5] %}
                    <!-- Simplified HN Item logic: Rank + Title only -->
                    <div class="flex items-center justify-between group py-3 border-b-2 border-gray-100 last:border-0 h-[88px]"> <!-- Fixed height constraint or consistent padding -->
                        <div class="flex items-center flex-1 min-w-0 mr-4">
                            <!-- Rank -->
                            <span class="text-5xl font-black mr-4 min-w-[3rem] text-right text-gray-300 group-hover:text-black leading-none shrink-0">{{ loop.index }}.</span>
                            
                            <!-- Title (Dynamic font size: 5xl default, 4xl if wrapped) -->
                            <span class="hn-story-title text-5xl font-bold text-black leading-tight line-clamp-2 break-words whitespace-normal">
                                {{ story.title }}
                            </span>
                        </div>
                        <!-- Score (Small gray number, Black if breaking) -->
                        <span class="text-3xl font-bold {% if story.is_breaking %}text-black{% else %}text-gray-400{% endif %} shrink-0 min-w-[3rem] text-right">
                             {{ story.score }}
                        </span>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Right: Financials (Remaining 35%) -->
            <div class="bg-black flex-1 flex flex-col gap-[4px]">
                {% for item in finance %}
                <div class="panel flex-1 flex flex-col justify-center px-6 py-2">
                    <!-- Row 1: Name + Price -->
                    <div class="flex justify-between items-end mb-2">
                        <span class="text-4xl font-black leading-none">{{ item.name }}</span>
                        <span class="text-6xl font-black leading-none tracking-tighter">{{ item.price }}</span>
                    </div>
                    
                    <!-- Row 2: Sparkline + Change -->
                    <!-- Compressed height to prevent cutoff -->
                    <div class="flex items-end justify-between h-[120px]">
                         <!-- Sparkline -->
                        <div class="flex-grow h-full mr-4 relative">
                            {% if item.chart %}
                            <img src="data:image/png;base64,{{ item.chart }}" class="w-full h-full grayscale contrast-200" style="object-fit: fill;">
                            <!-- Baseline -->
                            <div class="absolute bottom-0 left-0 right-0 border-b-2 border-gray-300"></div>
                            {% else %}
                            <div class="w-full h-full bg-gray-100 flex items-center justify-center text-xl font-bold">N/A</div>
                            {% endif %}
                        </div>

                       <!-- Change Badge -->
                        <div class="shrink-0 mb-2">
                            {% if item.change >= 0 %}
                            <span class="text-4xl font-bold bg-black text-white px-3 py-2 block min-w-[150px] text-center">▲ {{ "%.2f"|format(item.change) }}%</span>
                            {% else %}
                            <span class="text-4xl font-bold border-b-4 border-black text-black px-1 block min-w-[150px] text-center">▼ {{ "%.2f"|format(item.change) }}%</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

        </div>

    </div>

    <script>
        // Dynamic Font Sizing for HN Titles
        window.addEventListener('load', () => {
            const titles = document.querySelectorAll('.hn-story-title');
            titles.forEach(title => {
                // Check if the title text wraps to more than one line
                // We compare scrollHeight to the calculated line-height
                const style = window.getComputedStyle(title);
                const lineHeight = parseFloat(style.lineHeight);
                // Buffer of 10% to account for sub-pixel rendering differences
                if (title.scrollHeight > lineHeight * 1.1) {
                    title.classList.remove('text-5xl');
                    title.classList.add('text-4xl');
                }
            });
        });
    </script>
</body>
</html>

